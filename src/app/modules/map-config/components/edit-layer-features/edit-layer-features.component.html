<ng-container [formGroup]="modeFormGroup">
    <mat-horizontal-stepper #stepper class="stepper-for-config-element">

        <mat-step label="Collection" formGroupName="collectionStep" [stepControl]="modeFormGroup.get('collectionStep')">
            <app-config-element>
                <div form-fields>
                    <mat-form-field>
                        <mat-label>Collection</mat-label>
                        <mat-select formControlName="collectionCtrl"
                            appAlertOnChange="changing the collection will reset the rendered geometry"
                            [dependants]="[modeFormGroup.get('geometryStep').get('geometryCtrl')]">
                            <mat-option value="col1">col1</mat-option>
                            <mat-option value="col2">col2</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div description>
                </div>
            </app-config-element>
            <div>
                <button mat-button matStepperNext type="button">Next</button>
            </div>
        </mat-step>

        <mat-step label="Geometry" formGroupName="geometryStep" [stepControl]="modeFormGroup.get('geometryStep')">
            <app-config-element>
                <div form-fields>
                    <mat-form-field>
                        <mat-label>Rendered geometry</mat-label>
                        <mat-select formControlName="geometryCtrl">
                            <mat-option value="geopoint">a geopoint</mat-option>
                            <mat-option value="geoshape">a geoshape</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div description>
                </div>
            </app-config-element>
            <app-config-element>
                <div form-fields>
                    <mat-form-field>
                        <mat-label>Geometry type</mat-label>
                        <mat-select formControlName="geometryTypeCtrl">
                            <mat-option value="fill">Fill</mat-option>
                            <mat-option value="line">Line</mat-option>
                            <mat-option value="circle">Circle</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div description>

                </div>
            </app-config-element>
            <div>
                <button mat-button matStepperPrevious>Back</button>
                <button mat-button matStepperNext type="button">Next</button>
            </div>
        </mat-step>

        <mat-step label="Visibility" formGroupName="visibilityStep" [stepControl]="modeFormGroup.get('visibilityStep')">
            <mat-error *ngIf="modeFormGroup.controls.visibilityStep.errors?.lte">
                Zoom max must be greater than or equal to zoom min
            </mat-error>
            <app-config-element>
                <div form-fields>
                    <mat-slide-toggle formControlName="visibleCtrl" labelPosition="before">Visible</mat-slide-toggle>
                </div>
                <div description>
                    description
                </div>
            </app-config-element>
            <app-config-element>
                <div form-fields>
                    <mat-label>Zoom min</mat-label>
                    <mat-slider thumbLabel formControlName="zoomMinCtrl" min="0" max="20" thumbLabel="true">
                    </mat-slider>
                </div>
                <div description>
                    zoom min etc
                </div>
            </app-config-element>
            <app-config-element>
                <div form-fields>
                    <span>Zoom max</span>
                    <mat-slider thumbLabel formControlName="zoomMaxCtrl" min="0" max="20"> </mat-slider>
                </div>
                <div description>
                    zoom max etc
                </div>
            </app-config-element>
            <app-config-element>
                <div form-fields>
                    <span>
                        <mat-label>Features max</mat-label>
                        <mat-slider #featuresMaxCtrlSlider formControlName="featuresMaxCtrl"
                            [value]="modeFormGroup.get('visibilityStep').get('featuresMaxCtrl').value" thumbLabel
                            min="0" max="10000" step="100"> </mat-slider>
                    </span>
                </div>
                <div description>
                    Features max etc
                </div>
            </app-config-element>
            <div>
                <button mat-button matStepperPrevious>Back</button>
                <button mat-button matStepperNext type="button">Next</button>
            </div>
        </mat-step>

        <mat-step label="Style" formGroupName="styleStep" [stepControl]="modeFormGroup.get('styleStep')">
            <app-config-element>
                <div form-fields>
                    <mat-label>Opacity</mat-label>
                    <mat-slider thumbLabel formControlName="opacityCtrl" min="0" max="1" thumbLabel="true" step="0.1">
                    </mat-slider>
                </div>
                <div description>
                    opacity...
                </div>
            </app-config-element>

            <app-config-element>
                <div form-fields>
                    <mat-form-field>
                        <mat-label>Color source</mat-label>
                        <mat-select formControlName="colorSourceCtrl"
                            appAlertOnChange="changing the color source will reset the choosen color(s)"
                            [dependants]="[colorFixCtrl(), colorProvidedFieldCtrl(), colorGeneratedFieldCtrl(), colorSetFieldCtrl()]">
                            <mat-option value="fix">Fix</mat-option>
                            <mat-option value="provided">Provided by a field</mat-option>
                            <mat-option value="generated">Generated from a field</mat-option>
                            <mat-option value="manual">Choosen from a field</mat-option>
                            <mat-option value="interpolated">Interpolated from a field</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <div>
                        <ng-container formGroupName="choosenColorGrp">

                            <span *ngIf="colorSourceCtrl().value == 'fix'">
                                <app-color-picker [value]="colorFixCtrl().value" (setValue)="setColorFix($event)">
                                </app-color-picker>
                            </span>

                            <span *ngIf="colorSourceCtrl().value == 'provided'">
                                <mat-form-field>
                                    <mat-label>Source field</mat-label>
                                    <mat-select formControlName="colorProvidedFieldCtrl">
                                        <mat-option value="a">field a</mat-option>
                                        <mat-option value="b">field b</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </span>

                            <span *ngIf="colorSourceCtrl().value == 'generated'">
                                <mat-form-field>
                                    <mat-label>Source field</mat-label>
                                    <mat-select formControlName="colorGeneratedFieldCtrl">
                                        <mat-option value="a">field a</mat-option>
                                        <mat-option value="b">field b</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </span>

                            <span *ngIf="colorSourceCtrl().value == 'manual'">
                                <mat-form-field>
                                    <mat-label>Source field</mat-label>
                                    <!-- No [dependants] because we manually set the new values on source field change -->
                                    <mat-select formControlName="colorSetFieldCtrl"
                                        appAlertOnChange="Changing the source field will reset the colors">
                                        <mat-option value="a">field a</mat-option>
                                        <mat-option value="b">field b</mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <span>
                                    <button type="button" mat-raised-button color="primary" (click)="openColorTable()"
                                        *ngIf="colorSetFieldCtrl()?.value">
                                        View / change colors
                                    </button>
                                </span>
                            </span>

                            <div *ngIf="choosenColorGrp()?.invalid && choosenColorGrp()?.touched">
                                <mat-error *ngIf="colorFixCtrl()?.errors?.required">
                                    A color is required
                                </mat-error>
                                <mat-error
                                    *ngIf="colorProvidedFieldCtrl()?.errors?.required 
                                || colorGeneratedFieldCtrl()?.errors?.required || colorSetFieldCtrl()?.errors?.required">
                                    A source field is required
                                </mat-error>
                            </div>

                        </ng-container>
                    </div>

                </div>
                <div description>
                    <p>
                        Fix: use a fix color.
                    </p>
                    <p>
                        Provided by a field: select a field whose values are the colors to use.
                    </p>
                    <p>
                        Generated from a field: select a field of type 'keyword', then a color will be generated for
                        every
                        possible value.
                    </p>
                    <p>
                        Choosen from a field: select a field of type 'keyword', then select a color for every possible
                        value.
                    </p>
                    <p>
                        Interpolated from a field: select a number or date field, colors will be lineary interpolated
                        between the min and the max.
                    </p>
                </div>
            </app-config-element>
            <button mat-button matStepperPrevious>Back</button>
        </mat-step>

    </mat-horizontal-stepper>
</ng-container>